(lang dune 3.20)

(name pegasus)

(generate_opam_files true)

(source (github futurGH/pegasus))
(authors "futurGH")
(maintainers "futurGH")

(license MPL-2.0)

(pin ; fixes build on macOS 26
 (url "git+https://github.com/mcksan/pg_query-ocaml.git")
 (package (name pg_query)))

(pin ; build broken on macOS for some reason
 (url "git+https://github.com/futurGH/bin_prot.git") ; https://github.com/janestreet/bin_prot pinned to #03c783d
 (package
   (name bin_prot)
   (version v0.17~preview.128.20+135))) ; this is actually v0.16~preview.128.20+135 but some other package requires >=v0.17

(pin ; these 3 all need to be pinned or they'll conflict
 (url "git+https://github.com/aantron/dream.git")
 (package (name dream)))
(pin
 (url "git+https://github.com/roddyyaga/ppx_rapper.git")
 (package (name ppx_rapper)))
(pin
 (url "git+https://github.com/roddyyaga/ppx_rapper.git")
 (package (name ppx_rapper_lwt)))

(package
 (name pegasus)
 (synopsis "An atproto Personal Data Server implementation")
 (description "Eventually")
 (allow_empty)
 (depends
  (ocaml (= 5.2.1))
  dune
  lwt
  (caqti (>= 1.9.0))
  (caqti-driver-sqlite3 (>= 1.9.0))
  (caqti-lwt (>= 1.9.0))
  (cohttp (>= 6.1.1))
  (cohttp-lwt-unix (>= 6.1.1))
  (dns-client (>= 10.2.0))
  dream
  (re (>= 1.13.2))
  (safepass (>= 3.1))
  (timedesc (>= 3.1.0))
  (uuidm (>= 0.9.10))
  (yojson (>= 3.0.0))
  (lwt_ppx (>= 5.9.1))
  (ppx_deriving_yojson (>= 3.9.1))
  ppx_rapper
  ppx_rapper_lwt
  (alcotest :with-test)))

(package
 (name mist)
 (synopsis "Atproto repo functionality")
 (allow_empty)
 (depends
  (ocaml (= 5.2.1))
  dune
  lwt
  (core_unix (>= 0.16.0))
  (re (>= 1.13.2))
  (yojson (>= 3.0.0))
  (lwt_ppx (>= 5.9.1))
  (ppx_deriving_yojson (>= 3.9.1))
  (alcotest :with-test)))

(package
 (name ipld)
 (synopsis "A DASL-compliant implementation of some IPLD formats")
 (description "Currently includes DAG-CBOR, CIDv1, and CARv1")
 (allow_empty)
 (depends
  (ocaml (= 5.2.1))
  dune
  lwt
  (digestif (>= 1.2.0))
  (multibase (>= 0.1.0))
  (yojson (>= 3.0.0))
  (lwt_ppx (>= 5.9.1))
  (alcotest :with-test)))

(package
 (name kleidos)
 (synopsis "Atproto-flavour k256 and p256 signing and verification")
 (allow_empty)
 (depends
  (ocaml (= 5.2.1))
  dune
  (hacl-star (>= 0.7.2))
  (mirage-crypto-ec (>= 2.0.1))
  (multibase (>= 0.1.0))))
